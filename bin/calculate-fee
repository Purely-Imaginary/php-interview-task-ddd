#!/usr/bin/env php
<?php

$container = require_once dirname(__DIR__) . '/config/bootstrap.php';

use Lendable\Interview\Application\Handler\CalculateFeeHandler;
use Lendable\Interview\Application\Service\OutputFormatter;
use Lendable\Interview\Domain\Model\Loan\Money;
use Lendable\Interview\Domain\Model\Loan\Term;

require_once dirname(__DIR__).'/vendor/autoload.php';

/**
 * Please note that you CAN modify this file in any way to suit your needs, but be advised that it MUST conform to
 * the contract specified in the README of the test.
 */

if ($argc !== 3) {
    fwrite(STDERR, "Usage: bin/calculate-fee <amount> <term>\n");
    exit(1);
}

$amountString = $argv[1];
$termString = $argv[2];


try {
    $handler = $container->get(CalculateFeeHandler::class);
    $formatter = $container->get(OutputFormatter::class);

    $moneyVO = Money::fromDecimalString($amountString);
    $termVO = Term::fromMonths((int) $termString);
    $fee = $handler->handle($moneyVO, $termVO);
    $formattedFee = $formatter->format($fee);
    fwrite(STDOUT, $formattedFee."\n");

    exit(0);
} catch (\Throwable $e) { // Catching all for simplicity, we could handle different exceptions differently
    fwrite(STDERR, $e->getMessage()."\n");
    exit(1);
}

